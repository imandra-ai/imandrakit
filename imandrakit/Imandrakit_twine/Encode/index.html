<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Encode (imandrakit.Imandrakit_twine.Encode)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">imandrakit</a> &#x00BB; <a href="../index.html">Imandrakit_twine</a> &#x00BB; Encode</nav><header class="odoc-preamble"><h1>Module <code><span>Imandrakit_twine.Encode</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#primitives">Primitives</a></li><li><a href="#arrays">Arrays</a></li><li><a href="#dictionaries">Dictionaries</a></li><li><a href="#sum-types">Sum types</a></li><li><a href="#top-value">Top value</a></li><li><a href="#caching">Caching</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Immediate"><a href="#module-Immediate" class="anchor"></a><code><span><span class="keyword">module</span> Immediate</span><span> = <a href="../Immediate/index.html">Immediate</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-immediate"><a href="#type-immediate" class="anchor"></a><code><span><span class="keyword">type</span> immediate</span><span> = <a href="../Immediate/index.html#type-t">Immediate.t</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>New encoder.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reset"><a href="#val-reset" class="anchor"></a><code><span><span class="keyword">val</span> reset : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Reset the encoder. Previous slices obtained via <a href="#val-finalize"><code>finalize</code></a> are invalidated.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-encoder"><a href="#type-encoder" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a encoder</span></span><span> = <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ignore_offset"><a href="#val-ignore_offset" class="anchor"></a><code><span><span class="keyword">val</span> ignore_offset : <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Used when we don't use the resulting offset</p></div></div><h3 id="primitives"><a href="#primitives" class="anchor"></a>Primitives</h3><div class="odoc-spec"><div class="spec value anchored" id="val-write_immediate"><a href="#val-write_immediate" class="anchor"></a><code><span><span class="keyword">val</span> write_immediate : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-immediate">immediate</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>write_immediate enc i</code> writes down <code>i</code> and returns an immediate pointer to it</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write_or_ref_immediate"><a href="#val-write_or_ref_immediate" class="anchor"></a><code><span><span class="keyword">val</span> write_or_ref_immediate : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-immediate">immediate</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>write_or_deref_immediate enc i</code> looks at <code>i</code>, and if <code>i</code> is <code>Pointer p</code>, it returns <code>p</code>; otherwise it writes down <code>i</code> and returns a pointer to it.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-tag"><a href="#val-tag" class="anchor"></a><code><span><span class="keyword">val</span> tag : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">tag</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="label">v</span>:<a href="#type-immediate">immediate</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><h3 id="arrays"><a href="#arrays" class="anchor"></a>Arrays</h3><div class="odoc-spec"><div class="spec value anchored" id="val-array_init"><a href="#val-array_init" class="anchor"></a><code><span><span class="keyword">val</span> array_init : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a>)</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-array"><a href="#val-array" class="anchor"></a><code><span><span class="keyword">val</span> array : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-immediate">immediate</a> array</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-array_iter"><a href="#val-array_iter" class="anchor"></a><code><span><span class="keyword">val</span> array_iter : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-immediate">immediate</a> <a href="../../../iter/Iter/index.html#type-t">Iter.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-list"><a href="#val-list" class="anchor"></a><code><span><span class="keyword">val</span> list : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-immediate">immediate</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><h3 id="dictionaries"><a href="#dictionaries" class="anchor"></a>Dictionaries</h3><div class="odoc-spec"><div class="spec value anchored" id="val-dict"><a href="#val-dict" class="anchor"></a><code><span><span class="keyword">val</span> dict : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a> * <a href="#type-immediate">immediate</a>)</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dict_iter"><a href="#val-dict_iter" class="anchor"></a><code><span><span class="keyword">val</span> dict_iter : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-immediate">immediate</a> * <a href="#type-immediate">immediate</a>)</span> <a href="../../../iter/Iter/index.html#type-t">Iter.t</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-dict_list"><a href="#val-dict_list" class="anchor"></a><code><span><span class="keyword">val</span> dict_list : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<a href="#type-immediate">immediate</a> * <a href="#type-immediate">immediate</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><h3 id="sum-types"><a href="#sum-types" class="anchor"></a>Sum types</h3><div class="odoc-spec"><div class="spec value anchored" id="val-cstor"><a href="#val-cstor" class="anchor"></a><code><span><span class="keyword">val</span> cstor : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">index</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-immediate">immediate</a> array</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-immediate">immediate</a></span></code></div></div><h3 id="top-value"><a href="#top-value" class="anchor"></a>Top value</h3><div class="odoc-spec"><div class="spec value anchored" id="val-finalize"><a href="#val-finalize" class="anchor"></a><code><span><span class="keyword">val</span> finalize : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">entrypoint</span>:<a href="#type-immediate">immediate</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Imandrakit_bytes/Byte_slice/index.html#type-t">Imandrakit_bytes.Byte_slice.t</a></span></code></div><div class="spec-doc"><p>Finalize by writing the entrypoint, and get the result as a byte slice</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">top</span> <p>the offset of the toplevel/entrypoint value</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-finalize_copy"><a href="#val-finalize_copy" class="anchor"></a><code><span><span class="keyword">val</span> finalize_copy : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">entrypoint</span>:<a href="#type-immediate">immediate</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Finalize, and get a copy of the result. See <a href="#val-finalize"><code>finalize</code></a></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-encode_to_string"><a href="#val-encode_to_string" class="anchor"></a><code><span><span class="keyword">val</span> encode_to_string : <span><span class="optlabel">?encoder</span>:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-encoder">encoder</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Full entrypoint</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_string"><a href="#val-to_string" class="anchor"></a><code><span><span class="keyword">val</span> to_string : <span><span class="optlabel">?encoder</span>:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-encoder">encoder</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><ul class="at-tags"><li class="deprecated"><span class="at-tag">deprecated</span> use encode_to_string instead</li></ul></div></div><h3 id="caching"><a href="#caching" class="anchor"></a>Caching</h3><p>Caching is used to create/preserve sharing in the encoded slice, by actively storing, in a hashtable, the offset where a value was previously encoded.</p><div class="odoc-spec"><div class="spec type anchored" id="type-cache_key"><a href="#type-cache_key" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a cache_key</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create_cache_key"><a href="#val-create_cache_key" class="anchor"></a><code><span><span class="keyword">val</span> create_cache_key : 
  <span><span>(<span class="keyword">module</span> <a href="../../../ocaml/Stdlib/Hashtbl/module-type-HashedType/index.html">Stdlib.Hashtbl.HashedType</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="../../../ocaml/Stdlib/Hashtbl/module-type-HashedType/index.html#type-t">t</a> = <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-cache_key">cache_key</a></span></span></code></div><div class="spec-doc"><p>Create a new (generative) cache key for a hashable + comparable type.</p><p><b>NOTE</b> this should be called only at module toplevel, as a constant, not dynamically inside a function: <code>let key = create_cache_key (module …);;</code>. Indeed, this is generative, so creating multiple keys for a type will result in sub-par or inexistant caching.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_cache"><a href="#val-with_cache" class="anchor"></a><code><span><span class="keyword">val</span> with_cache : 
  <span><span class="optlabel">?max_string_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-cache_key">cache_key</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-encoder">encoder</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-encoder">encoder</a></span></span></code></div><div class="spec-doc"><p><code>with_cache key enc</code> is the same encoder as <code>enc</code>, but with caching. When encoding a value <code>x:'a</code>, the cache <code>key</code> is used to detect if <code>x</code> was already encoded to some entry, and uses a pointer to this entry instead of re-serializing <code>x</code>.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">max_string_size</span> <p>strings and blobs above this size are written once and referred to by pointer</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_cache"><a href="#val-add_cache" class="anchor"></a><code><span><span class="keyword">val</span> add_cache : 
  <span><span class="optlabel">?max_string_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="keyword">module</span> <a href="../../../ocaml/Stdlib/Hashtbl/module-type-HashedType/index.html">Stdlib.Hashtbl.HashedType</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="../../../ocaml/Stdlib/Hashtbl/module-type-HashedType/index.html#type-t">t</a> = <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span class="type-var">'a</span> <a href="#type-encoder">encoder</a></span> <a href="../../../ocaml/Stdlib/index.html#type-ref">ref</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>add_cache (module …) enc_ref</code> modifies the given encoder so that it goes through a layer of caching. This is the same as:</p><pre class="language-ocaml"><code>let key = create_cache_key (module …)
let () = enc_ref := with_cache key !enc_ref</code></pre></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_cache_with"><a href="#val-add_cache_with" class="anchor"></a><code><span><span class="keyword">val</span> add_cache_with : 
  <span><span class="optlabel">?max_string_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">eq</span>:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> bool)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">hash</span>:<span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> int)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span><span class="type-var">'a</span> <a href="#type-encoder">encoder</a></span> <a href="../../../ocaml/Stdlib/index.html#type-ref">ref</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Shortcut for <a href="#val-add_cache"><code>add_cache</code></a></p></div></div></div></body></html>
