<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Imandrakit_twine (imandrakit.Imandrakit_twine)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">imandrakit</a> &#x00BB; Imandrakit_twine</nav><header class="odoc-preamble"><h1>Module <code><span>Imandrakit_twine</span></code></h1><p>A data format designed to represent complex OCaml values.</p><p>The format is designed for 0-copy parsing (or, not much copy anyway) and reasonable compactness.</p><p>https://github.com/imandra-ai/imandrakit/discussions/2</p><p># Overview</p><p>The encoding relies on a first byte to disambiguate between values. The first byte is a bitfield <code>kind:4 low:4</code> where:</p><ul><li><code>kind</code> is the kind of value (int, float, etc.)</li><li><code>low</code> is a small integer value whose meaning depends on the kind. It can be a small integer, or a length, or a special value, or a constructor index. In case the value needs an integer argument <code>n</code> (length, actual integer, element count, etc.), this integer argument is encoded in <code>low</code>, but if <code>n&gt;=15</code> then <code>low = 15</code> and <code>n-15</code> is encoded as LEB128 immediately after the first byte.</li></ul><p>kinds:</p><ul><li>0: special. n=0: false n=1: true n=2: nil Other values of <code>n</code> are reserved.</li><li>1: positive int, value is <code>n</code>.</li><li>2: negative int, value is <code>-n-1</code></li><li>3: float. if <code>n=0</code> then it's a float32, 4 bytes follow (little-endian); if <code>n=1</code> then it's a float64, 8 bytes follow (little-endian). Other values of <code>n</code> are reserved.</li><li>4: string, length in bytes is <code>n</code>. <code>n</code> bytes follow.</li><li>5: binary blob, length in bytes is <code>n</code>. <code>n</code> bytes follow.</li><li>6: array, number of elements is <code>n</code>. Immediate elements follow.</li><li>7: dict, number of key/value pairs is <code>n</code>. <code>2*n</code> immediate elements follow.</li><li>8: tag, the tag number is <code>n</code>. A single immediate element follows.</li><li>9: reserved</li><li>10: cstor0, constructor index is <code>n</code></li><li>11: cstor1, constructor index is <code>n</code>, a single immediate argument follows</li><li>12: cstorN, constructor index is <code>n</code>, length as LEB128 follows (probably just one byte), then immediate arguments follow</li><li>13: reserved</li><li>14: ref, relative offset to the pointed value is <code>n</code>. If we're at offset <code>i</code>, then the reference points to <code>i-n-1</code>. Not automatically dereferenced on parsing.</li><li>15: pointer, relative offset to the pointed value is <code>n</code>. If we're at offset <code>i</code>, then the pointer points to <code>i-n-1</code>.</li></ul><p>The toplevel value is written last, and to find it, a valid Twine blob must end with a byte <code>n:u8</code> that indicates where this last value starts. If the last byte <code>n</code> is at address <code>off</code>, then the actual last value starts at <code>off-n-1</code>. If the last value is too big, it's turned into a pointer and that's what that last byte targets.</p><p>An immediate element is, basically, a non-recursive case that is easy to <b>skip</b> over to get to the next element. It includes booleans, integers, floats, strings, pointers, but not arrays or dictionaries (which must be encoded somewhere else and referred to by a pointer).</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-offset_for"><a href="#type-offset_for" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a offset_for</span></span><span> = </span></code><ol><li id="type-offset_for.Offset_for" class="def variant constructor anchored"><a href="#type-offset_for.Offset_for" class="anchor"></a><code><span>| </span><span><span class="constructor">Offset_for</span> <span class="keyword">of</span> int</span></code></li></ol></div><div class="spec-doc"><p>A typed offset</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_offset_for"><a href="#val-pp_offset_for" class="anchor"></a><code><span><span class="keyword">val</span> pp_offset_for : 
  'a. <span><span>(<span><a href="../../ocaml/Stdlib/Format/index.html#type-formatter">Ppx_deriving_runtime.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
        <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
        <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-unit">Ppx_deriving_runtime.unit</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../ocaml/Stdlib/Format/index.html#type-formatter">Ppx_deriving_runtime.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-offset_for">offset_for</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-unit">Ppx_deriving_runtime.unit</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show_offset_for"><a href="#val-show_offset_for" class="anchor"></a><code><span><span class="keyword">val</span> show_offset_for : 
  'a. <span><span>(<span><a href="../../ocaml/Stdlib/Format/index.html#type-formatter">Ppx_deriving_runtime.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
        <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
        <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-unit">Ppx_deriving_runtime.unit</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-offset_for">offset_for</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-string">Ppx_deriving_runtime.string</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-equal_offset_for"><a href="#val-equal_offset_for" class="anchor"></a><code><span><span class="keyword">val</span> equal_offset_for : 
  'a. <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-bool">Ppx_deriving_runtime.bool</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-offset_for">offset_for</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-offset_for">offset_for</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-bool">Ppx_deriving_runtime.bool</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compare_offset_for"><a href="#val-compare_offset_for" class="anchor"></a><code><span><span class="keyword">val</span> compare_offset_for : 
  'a. <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-int">Ppx_deriving_runtime.int</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-offset_for">offset_for</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-offset_for">offset_for</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-int">Ppx_deriving_runtime.int</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-slice"><a href="#type-slice" class="anchor"></a><code><span><span class="keyword">type</span> slice</span><span> = <a href="../Imandrakit_bytes/Byte_slice/index.html#type-t">Imandrakit_bytes.Byte_slice.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_slice"><a href="#val-pp_slice" class="anchor"></a><code><span><span class="keyword">val</span> pp_slice : 
  <span><a href="../../ocaml/Stdlib/Format/index.html#type-formatter">Ppx_deriving_runtime.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-slice">slice</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-unit">Ppx_deriving_runtime.unit</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show_slice"><a href="#val-show_slice" class="anchor"></a><code><span><span class="keyword">val</span> show_slice : <span><a href="#type-slice">slice</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-string">Ppx_deriving_runtime.string</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-buf"><a href="#type-buf" class="anchor"></a><code><span><span class="keyword">type</span> buf</span><span> = <a href="../Imandrakit_bytes/Byte_buf/index.html#type-t">Imandrakit_bytes.Byte_buf.t</a></span></code></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-Error"><a href="#exception-Error" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Error</span> <span class="keyword">of</span> string</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Immediate"><a href="#module-Immediate" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Immediate/index.html">Immediate</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Encode"><a href="#module-Encode" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Encode/index.html">Encode</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Decode"><a href="#module-Decode" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Decode/index.html">Decode</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Dump"><a href="#module-Dump" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Dump/index.html">Dump</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Produce a debug dump of the given Twine value</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Util"><a href="#module-Util" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Util/index.html">Util</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-immediate"><a href="#type-immediate" class="anchor"></a><code><span><span class="keyword">type</span> immediate</span><span> = <a href="Immediate/index.html#type-t">Immediate.t</a></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-offset"><a href="#type-offset" class="anchor"></a><code><span><span class="keyword">type</span> offset</span><span> = int</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-equal_offset"><a href="#val-equal_offset" class="anchor"></a><code><span><span class="keyword">val</span> equal_offset : <span><a href="#type-offset">offset</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-offset">offset</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-bool">Ppx_deriving_runtime.bool</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_offset"><a href="#val-pp_offset" class="anchor"></a><code><span><span class="keyword">val</span> pp_offset : 
  <span><a href="../../ocaml/Stdlib/Format/index.html#type-formatter">Ppx_deriving_runtime.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-offset">offset</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-unit">Ppx_deriving_runtime.unit</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show_offset"><a href="#val-show_offset" class="anchor"></a><code><span><span class="keyword">val</span> show_offset : <span><a href="#type-offset">offset</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-string">Ppx_deriving_runtime.string</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compare_offset"><a href="#val-compare_offset" class="anchor"></a><code><span><span class="keyword">val</span> compare_offset : <span><a href="#type-offset">offset</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-offset">offset</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../ppx_deriving/Ppx_deriving_runtime/index.html#type-int">Ppx_deriving_runtime.int</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-offset_for_to_twine'"><a href="#val-offset_for_to_twine'" class="anchor"></a><code><span><span class="keyword">val</span> offset_for_to_twine' : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-offset_for">offset_for</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="Immediate/index.html#type-t">Immediate.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-offset_for_to_twine"><a href="#val-offset_for_to_twine" class="anchor"></a><code><span><span class="keyword">val</span> offset_for_to_twine : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'c</span> <a href="#type-offset_for">offset_for</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="Immediate/index.html#type-t">Immediate.t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-offset_for_of_twine"><a href="#val-offset_for_of_twine" class="anchor"></a><code><span><span class="keyword">val</span> offset_for_of_twine : <span><span><span class="type-var">'a</span> <a href="#type-offset_for">offset_for</a></span> <a href="Decode/index.html#type-decoder">Decode.decoder</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-encoder"><a href="#type-encoder" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a encoder</span></span><span> = <span><span class="type-var">'a</span> <a href="Encode/index.html#type-encoder">Encode.encoder</a></span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-decoder"><a href="#type-decoder" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a decoder</span></span><span> = <span><span class="type-var">'a</span> <a href="Decode/index.html#type-decoder">Decode.decoder</a></span></span></code></div></div></div></body></html>
